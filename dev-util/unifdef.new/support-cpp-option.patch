--- unifdefall.sh.1	2009-06-29 01:43:05.000000000 +0800
+++ unifdefall.sh	2009-06-29 01:39:57.000000000 +0800
@@ -5,12 +5,32 @@
 #	$dotat: things/unifdefall.sh,v 1.9 2002/09/24 19:43:57 fanf2 Exp $
 # $FreeBSD: src/usr.bin/unifdef/unifdefall.sh,v 1.2 2002/09/24 19:50:03 fanf Exp $
 
+if [ $# = 1 ]; then
+	file=$1
+	shift
+fi
+
+while arg=$1; i=$#; shift; do
+	[ $i = 0 ] && break;
+	if [ $arg = -- ]; then
+		seperator=--
+		continue
+	fi
+	if [ "$seperator" = -- ]; then
+		file=$arg
+	else
+		opts="$opts $arg"
+	fi
+done
+
 set -e
 
 basename=`basename $0`
 tmp=`mktemp -d -t $basename.XXX` || exit 2
 
+set -- "$file"
 unifdef -s "$@" | sort | uniq > $tmp/ctrl
+set -- $opts "$file"
 cpp -dM "$@" | sort |
 	sed -re 's/^#define[ 	]+(.*[^	 ])[ 	]*$/\1/' > $tmp/hashdefs
 sed -re 's/^([A-Za-z0-9_]+).*$/\1/' $tmp/hashdefs > $tmp/alldef
@@ -24,6 +44,7 @@
 done < $tmp/def |
 	sed -re 's/\\/\\\\/g;s/"/\\"/g;s/^/"/;s/$/" \\/' >> $tmp/cmd
 echo '"$@"' >> $tmp/cmd
+set -- "$file"
 sh $tmp/cmd "$@" || test $? = 1
 
 rm -r $tmp
